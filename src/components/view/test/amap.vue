<template>
<div>
  <div v-for="(item, index) in items" :key="index">
    <div @click="startReadRaw(index)">{{item.name}}</div>
    <div :id="'mapView' + index" class="amap-container"></div>
  </div>
</div>
</template>

<script>
  import AMap from 'AMap';
  import AMapUI from 'AMapUI';
  import { mapMutations } from 'vuex';
  export default {
    name: 'amap',
    data () {
      return {
        amap: '',
        pathSimplifierIns: '',
        scrollTop: '',
        scrollHeight: '',
        items: [
          {
            name: '轨迹01'
          },
          {
            name: '轨迹02'
          },
          {
            name: '轨迹03'
          },
          {
            name: '轨迹04'
          },
          {
            name: '轨迹05'
          }
        ]
      };
    },
    created () {
      this.setHeader();
    },
    beforeRouteLeave (to, from, next) {
      // 当前路由变化，且该组件被复调用时执行
      next();
    },
    mounted () {
      // this.startReadRaw(0);
    },
    methods: {
      ...mapMutations(['SET_HEADER']),
      setHeader () {
        this.SET_HEADER('首页');
      },
      toService () {
        this.$router.push({
          name: 'index',
          query: {
            id: 100
          }
        });
      },
      startReadRaw (idx) {
        this.readraw(idx);
      },
      readraw (idx) {
        this.amap = new AMap.Map('mapView' + idx, {
          center: [116.39, 39.9]
        });
        AMapUI.load(['ui/misc/PathSimplifier'], (PathSimplifier) => {
          if (!PathSimplifier.supportCanvas) {
            alert('当前环境不支持 Canvas！');
            return false;
          }
          this.initPage(PathSimplifier);
        });
      },
      initPage (PathSimplifier) {
        // 创建组件实例
        this.pathSimplifierIns = new PathSimplifier({
          zIndex: 100,
          map: this.amap, // 所属的地图实例
          getPath: function (pathData, pathIndex) {
            // 返回轨迹数据中的节点坐标信息，[AMap.LngLat, AMap.LngLat...] 或者 [[lng|number,lat|number],...]
            return pathData.path;
          },
          getHoverTitle: function (pathData, pathIndex, pointIndex) {
            // 返回鼠标悬停时显示的信息
            if (pointIndex >= 0) {
              // 鼠标悬停在某个轨迹节点上
              return pathData.name + '，点:' + pointIndex + '/' + pathData.path.length;
            }
            // 鼠标悬停在节点之间的连线上
            return pathData.name + '，点数量' + pathData.path.length;
          },
          renderOptions: {
            // 轨迹线的样式
            keyPointTolerance: 2,
            pathLineStyle: {
              strokeStyle: 'red',
              lineWidth: 6,
              dirArrowStyle: true
            }
          }
        });

        let potArr = [
            [
              120.17867612945497,
              29.17993127618853
            ],
            [
              120.17863869667053,
              29.179891347885132
            ],
            [
              120.17858505249023,
              29.179848432540894
            ],
            [
              120.17858505249023,
              29.179848432540894
            ],
            [
              120.17830073833466,
              29.180272221565247
            ],
            [
              120.17824709415436,
              29.18040096759796
            ],
            [
              120.17824172973633,
              29.180529713630676
            ],
            [
              120.17831146717072,
              29.181119799613953
            ],
            [
              120.17831146717072,
              29.181119799613953
            ],
            [
              120.17824172973633,
              29.180529713630676
            ],
            [
              120.17824709415436,
              29.18040096759796
            ],
            [
              120.17830073833466,
              29.180272221565247
            ],
            [
              120.17858505249023,
              29.179848432540894
            ],
            [
              120.17858505249023,
              29.179848432540894
            ],
            [
              120.17863869667053,
              29.179891347885132
            ],
            [
              120.179443359375,
              29.180749654769897
            ],
            [
              120.179443359375,
              29.180749654769897
            ],
            [
              120.17950773239136,
              29.181334376335144
            ],
            [
              120.17950773239136,
              29.181334376335144
            ],
            [
              120.17959356307983,
              29.18216586112976
            ],
            [
              120.17959356307983,
              29.18216586112976
            ],
            [
              120.17962574958801,
              29.18270766735077
            ],
            [
              120.1796042919159,
              29.183228015899658
            ],
            [
              120.17952382564545,
              29.183759093284607
            ],
            [
              120.17946481704712,
              29.18395757675171
            ],
            [
              120.17942190170288,
              29.184054136276245
            ],
            [
              120.17942190170288,
              29.184054136276245
            ],
            [
              120.17934679985046,
              29.184231162071228
            ],
            [
              120.17920196056366,
              29.184730052947998
            ],
            [
              120.17915368080139,
              29.184998273849487
            ],
            [
              120.17916977405548,
              29.18522357940674
            ],
            [
              120.17916977405548,
              29.18522357940674
            ],
            [
              120.17921268939972,
              29.18564200401306
            ],
            [
              120.17921268939972,
              29.18564200401306
            ],
            [
              120.1792985200882,
              29.18639302253723
            ],
            [
              120.1793360710144,
              29.18692946434021
            ],
            [
              120.1793360710144,
              29.18692946434021
            ],
            [
              120.17941117286682,
              29.188077449798584
            ],
            [
              120.17941117286682,
              29.188077449798584
            ],
            [
              120.17979741096497,
              29.188045263290405
            ],
            [
              120.17979741096497,
              29.188045263290405
            ],
            [
              120.18144428730011,
              29.1879540681839
            ],
            [
              120.18144428730011,
              29.1879540681839
            ],
            [
              120.18170177936554,
              29.18793797492981
            ],
            [
              120.18170177936554,
              29.18793797492981
            ],
            [
              120.18209874629974,
              29.18791651725769
            ],
            [
              120.18209874629974,
              29.18791651725769
            ],
            [
              120.1838207244873,
              29.187862873077393
            ],
            [
              120.1838207244873,
              29.187862873077393
            ],
            [
              120.18436253070831,
              29.187841415405273
            ],
            [
              120.18436253070831,
              29.187841415405273
            ],
            [
              120.18546760082245,
              29.187809228897095
            ],
            [
              120.18546760082245,
              29.187809228897095
            ],
            [
              120.18615424633026,
              29.187787771224976
            ],
            [
              120.18665313720703,
              29.187755584716797
            ],
            [
              120.18711447715759,
              29.187755584716797
            ],
            [
              120.18711447715759,
              29.187755584716797
            ],
            [
              120.18744707107544,
              29.187793135643005
            ],
            [
              120.18771529197693,
              29.187846779823303
            ],
            [
              120.18803179264069,
              29.18794870376587
            ],
            [
              120.18832683563232,
              29.188072085380554
            ],
            [
              120.18832683563232,
              29.188072085380554
            ],
            [
              120.18890082836151,
              29.188308119773865
            ],
            [
              120.18890082836151,
              29.188308119773865
            ],
            [
              120.18906712532043,
              29.188372492790222
            ],
            [
              120.18906712532043,
              29.188372492790222
            ],
            [
              120.18941044807434,
              29.188511967658997
            ],
            [
              120.18941044807434,
              29.188511967658997
            ],
            [
              120.1904296875,
              29.18893575668335
            ],
            [
              120.19156694412231,
              29.189413189888
            ],
            [
              120.19156694412231,
              29.189413189888
            ],
            [
              120.19180297851562,
              29.189515113830566
            ],
            [
              120.19180297851562,
              29.189515113830566
            ],
            [
              120.19310116767883,
              29.190046191215515
            ],
            [
              120.19310116767883,
              29.190046191215515
            ],
            [
              120.19342839717865,
              29.19016420841217
            ],
            [
              120.19373416900635,
              29.190250039100647
            ],
            [
              120.19435107707977,
              29.190362691879272
            ],
            [
              120.19435107707977,
              29.190362691879272
            ],
            [
              120.19506454467773,
              29.190486073493958
            ],
            [
              120.19553124904633,
              29.19063627719879
            ],
            [
              120.1956170797348,
              29.190673828125
            ],
            [
              120.19600868225098,
              29.190861582756042
            ],
            [
              120.19640028476715,
              29.191092252731323
            ],
            [
              120.19659340381622,
              29.191231727600098
            ],
            [
              120.19659340381622,
              29.191231727600098
            ],
            [
              120.19671142101288,
              29.191333651542664
            ],
            [
              120.19671142101288,
              29.191333651542664
            ],
            [
              120.19695818424225,
              29.191569685935974
            ],
            [
              120.19713521003723,
              29.191768169403076
            ],
            [
              120.19713521003723,
              29.191768169403076
            ],
            [
              120.19728541374207,
              29.191966652870178
            ],
            [
              120.19728541374207,
              29.191966652870178
            ],
            [
              120.19791841506958,
              29.19290006160736
            ],
            [
              120.19791841506958,
              29.19290006160736
            ],
            [
              120.19728541374207,
              29.191966652870178
            ],
            [
              120.19728541374207,
              29.191966652870178
            ],
            [
              120.19713521003723,
              29.191768169403076
            ],
            [
              120.19713521003723,
              29.191768169403076
            ],
            [
              120.19695818424225,
              29.191569685935974
            ],
            [
              120.19671142101288,
              29.191333651542664
            ],
            [
              120.19671142101288,
              29.191333651542664
            ],
            [
              120.19695818424225,
              29.191569685935974
            ],
            [
              120.19713521003723,
              29.191768169403076
            ],
            [
              120.19713521003723,
              29.191768169403076
            ],
            [
              120.1971961677137,
              29.191848720618417
            ]
          ];
        this.pathSimplifierIns.setData([
          {
            name: '轨迹0',
            path: potArr
          }
        ]);
        new AMap.GraspRoad().driving(potArr, function (error, result) {
          console.log(result);

          if (!error) {
            var path2 = [];

            var newPath = result.data.points;
            for (var i = 0; i < newPath.length; i += 1) {
              path2.push([newPath[i][0], newPath[i][1]]);
            }
            var newLine = new AMap.Polyline({
              path: path2,
              strokeWeight: 8,
              strokeOpacity: 0.7,
              strokeColor: 'green',
              showDir: true
            });
            this.amap.add(newLine);
            this.amap.setFitView();
          }
        });
        // 创建一个巡航器
        var navg0 = this.pathSimplifierIns.createPathNavigator(0, // 关联第1条轨迹
          {
            loop: true, // 循环播放
            speed: 100
          });

        navg0.start();
      }
    }
  };
</script>

<style lang="less" scoped>
  .amap-container {
    width: 100%;
    height: 500px;
  }
</style>
